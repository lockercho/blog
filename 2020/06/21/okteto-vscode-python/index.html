<!DOCTYPE html><html lang="zh-tw"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><meta name="author" content="Pei-Ya Chiu"><link rel="icon" href="/blog/favicon/favicon.ico"><title>PY 部落格</title><meta name="description" content=""><link rel="alternate" type="application/rss+xml" title="PY 部落格" href="/blog/atom.xml"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"><link rel="stylesheet" href="/blog/css/main.css"><link rel="stylesheet" href="/blog/css/highlight.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><meta name="generator" content="Hexo 4.2.1"></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/blog/" class="navbar-brand">PY 部落格</a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/blog/archives">Archive</a></li><li><a href="/blog/about/">About</a></li></ul></div><div class="avatar-container"><div class="avatar-img-border"><a href="/blog/"><img src="/blog/ellie.jpg" class="avatar-img"></a></div></div></div></nav><header class="header-section"><div class="intro-header no-img"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><h1>使用 VS Code + Oketo 在 Kubernetes 遠端開發 - 以 Python 為例</h1><p class="post-meta">Posted on 6月 21 2020</p></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><p>本文介紹如何使用 VS Code 上的 <a href="https://marketplace.visualstudio.com/items?itemName=okteto.remote-kubernetes" target="_blank" rel="noopener">Remote - Kubernetes</a> (Okteto) 插件來在 K8S Cluster 內遠端開發 Python application。</p>
<p>（本文的範例程式碼也可以在 GitHub 找到：<a href="https://github.com/lockercho/okteto-python-example" target="_blank" rel="noopener">https://github.com/lockercho/okteto-python-example</a> ）</p>
<h2 id="Okteto-介紹"><a class="header-anchor" href="#Okteto-介紹"></a>Okteto 介紹</h2>
<p>Okteto 這個工具會幫你在 Kubernetes 設定好開發用的 deployment、同步檔案至遠端、以及設定完成後自動開啟 Remote-SSH 連線至遠端環境。</p>
<h2 id="為什麼要使用遠端開發？"><a class="header-anchor" href="#為什麼要使用遠端開發？"></a>為什麼要使用遠端開發？</h2>
<p>假設使用這個開發中的 application 未來也會 deploy 在 k8s cluster 上，遠端開發可以提供以下好處：</p>
<ul>
<li>不用再多準備一份差很大 local config：在開發時可以直接使用 cluster config（儘管這份 config 可能是 dev 環境的，通常也會比 local config 更接近 production 環境）。</li>
<li>若開發的 application 依賴於 k8s 內的多個其他 service，直接在 cluster 內開發可以省去很多額外的 port forward 設定。</li>
<li>邪惡 debug 之術 😈：若使用運行中的 deployment 的名稱來建立環境，則 Okteto 會暫時取代掉原本的 deployment，開發結束才換回來（千萬別用在 production 環境，除非你百分之兩億知道自己在做什麼。)</li>
</ul>
<p>接下來就開始手把手講解如何建立一個 Kubernetes 內開發環境。</p>
<h2 id="設定流程"><a class="header-anchor" href="#設定流程"></a>設定流程</h2>
<h3 id="Step-1-準備一個-K8S-Cluster"><a class="header-anchor" href="#Step-1-準備一個-K8S-Cluster"></a>Step 1: 準備一個 K8S Cluster</h3>
<p>要設定 K8S 遠端開發，首先要準備一個你有權限跑 <code>kubectl apply</code> 的 K8S cluster。</p>
<p>如果沒有的話，<a href="https://cloud.okteto.com/#/login" target="_blank" rel="noopener">Okteto Cloud</a> 提供了免費的 cluster 可以使用，只要使用 GitHub 帳號註冊即可。（本文是使用 Mac OS X 上的 Docker Desktop 內建的 Kubernetes）</p>
<h3 id="Step-2-安裝-VS-Code-的-Remote-Kubernetes-Extension"><a class="header-anchor" href="#Step-2-安裝-VS-Code-的-Remote-Kubernetes-Extension"></a>Step 2: 安裝 VS Code 的 Remote - Kubernetes Extension</h3>
<p><a href="https://marketplace.visualstudio.com/items?itemName=okteto.remote-kubernetes" target="_blank" rel="noopener">Remote - Kubernetes</a></p>
<h3 id="Step-3-設定-Okteto-yaml"><a class="header-anchor" href="#Step-3-設定-Okteto-yaml"></a>Step 3: 設定 Okteto.yaml</h3>
<p>假設現在在開發一個 Python 的 hello-world 專案，你需要建立一個 <code>hello-world/okteto.yml</code> 檔案，內容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># name 會是開發用的 deployment name</span><br><span class="line">name: hello-world</span><br><span class="line"></span><br><span class="line"># 使用 Okteto 提供的 Python Image</span><br><span class="line">image: okteto&#x2F;python:3-dev</span><br><span class="line"></span><br><span class="line">command: [&quot;bash&quot;]</span><br><span class="line"></span><br><span class="line"># Source Code 會被同步至這個 dir</span><br><span class="line">workdir: &quot;&#x2F;opt&#x2F;src&#x2F;&quot;</span><br><span class="line"></span><br><span class="line"># 設定將遠端 port 5000 forward 到本機 port 25000，等等會用到</span><br><span class="line">forward:</span><br><span class="line">  - 25000:5000</span><br></pre></td></tr></table></figure>
<h3 id="Step-3-啟動遠端開發環境"><a class="header-anchor" href="#Step-3-啟動遠端開發環境"></a>Step 3: 啟動遠端開發環境</h3>
<p>接著 Cmd + Shift + p 開啟 Command Palette 使用 <code>Okteto: Up</code></p>
<div style="width:100%; text-align:center;">
<img src="/blog/2020/06/21/okteto-vscode-python/okteto-up.png" width="400px" title="Okteto Starting...">
</div>
<p>再選擇你剛剛建立的 <code>hello-world/okteto.yaml</code> 設定檔。</p>
<div style="width:100%; text-align:center;">
<img src="/blog/2020/06/21/okteto-vscode-python/okteto-select-manifest.png" width="400px" title="Okteto Starting...">
</div>
<br/>
選完設定檔後 VS Code 右下角會跳出提示正在準備你的 Remote 開發環境：
<div style="width:100%; text-align:center;">
<img src="/blog/2020/06/21/okteto-vscode-python/okteto-starting.png" width="400px" title="Okteto Starting...">
</div>
<p>環境建立好後 terminal 會顯示以下訊息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> ✓  Development container activated</span><br><span class="line"> ✓  Files synchronized</span><br><span class="line">    Namespace: default</span><br><span class="line">    Name:      python-okteto-sample</span><br><span class="line">    SSH:       22100 -&gt; 2222</span><br><span class="line">    Forward:   25000 -&gt; 5000</span><br><span class="line"></span><br><span class="line">Welcome to your development environment. Happy coding!</span><br><span class="line">okteto&gt;</span><br></pre></td></tr></table></figure>
<p>同時 VS Code 會開啟一個新的視窗，可以看到上面中間的標題與左下狀態都有標記 [SSH: XXX.okteto] 代表這個視窗是遠端環境：</p>
<div style="width:100%; text-align:center;">
<img src="/blog/2020/06/21/okteto-vscode-python/vscode-remote-welcome.png" width="800px" title="Okteto Starting...">
</div>
<h3 id="Step-4-設定-Python-環境"><a class="header-anchor" href="#Step-4-設定-Python-環境"></a>Step 4: 設定 Python 環境</h3>
<p>由於這個遠端是一個乾淨環境，所以需要重新安裝 Python 開發套件並 reload。</p>
<div style="width:100%; text-align:center;">
<img src="/blog/2020/06/21/okteto-vscode-python/vscode-install-python-small.png" width="400px" title="Okteto Starting...">
</div>
<p>接著選擇 Debugger 要使用的 Python Interpreter，Okteto 預設會幫你開一個 python <code>venv</code> 資料夾，但如果在 TERMINAL 下 <code>which python</code> 會發現是使用 <code>/usr/local/bin/python</code> 而非 <code>venv/bin/python</code>。這邊為了讓 debugger 方便抓到 pip 安裝的套件，我直接把 Interpreter 設定為 <code>/usr/local/bin/python</code>。</p>
<div style="width:100%; text-align:center;">
<img src="/blog/2020/06/21/okteto-vscode-python/vscode-select-interpreter.png" width="800px" title="VS Code: select interpreter">
</div>
<br>
<div style="width:100%; text-align:center;">
<img src="/blog/2020/06/21/okteto-vscode-python/vscode-select-python-version.png" width="800px" title="VS Code: select interpreter">
</div>
<p>接著使用 <code>Cmd +j</code> 叫出 VS Code TERMINAL，跑 <code>pip install Flask==1.1.2</code> 安裝 Flask</p>
<div style="width:100%; text-align:center;">
<img src="/blog/2020/06/21/okteto-vscode-python/flask-install.png" width="800px" title="Install flask">
</div>
<h3 id="Step-5-建立測試用的-Python-application"><a class="header-anchor" href="#Step-5-建立測試用的-Python-application"></a>Step 5: 建立測試用的 Python application</h3>
<p>接下來用 Flask 建立一個簡單的測試 app。</p>
<p>建立 <code>app.py</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># app.py</span><br><span class="line"></span><br><span class="line">from flask import Flask</span><br><span class="line"></span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&quot;&#x2F;hello&quot;)</span><br><span class="line">def hello():</span><br><span class="line">    return &quot;World!&quot;</span><br></pre></td></tr></table></figure>
<p>建立 <code>.vscode/launch.json</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot;: &quot;Python: Flask&quot;,</span><br><span class="line">            &quot;type&quot;: &quot;python&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;launch&quot;,</span><br><span class="line">            &quot;module&quot;: &quot;flask&quot;,</span><br><span class="line">            &quot;env&quot;: &#123;</span><br><span class="line">                &quot;FLASK_APP&quot;: &quot;app.py&quot;,</span><br><span class="line">                &quot;FLASK_ENV&quot;: &quot;development&quot;,</span><br><span class="line">                &quot;FLASK_DEBUG&quot;: &quot;0&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;args&quot;: [</span><br><span class="line">                &quot;run&quot;,</span><br><span class="line">                &quot;--no-debugger&quot;,</span><br><span class="line">                &quot;--no-reload&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>設定完了就可以使用 VS Code menu 的 <code>Run -&gt; Start Debugging</code> 或 <code>F5</code> 開始 debug。<br>
此時可以順便在 <code>line 7</code> 設定一個測試用的中斷點：</p>
<div style="width:100%; text-align:center;">
<img src="/blog/2020/06/21/okteto-vscode-python/python-run-success.png" width="800px" title="Install flask">
</div>
<p>由於一開始有設定了 Okteto 把 remote 的 <code>5000</code> port forward 到本機的 <code>25000</code> port，現在可以從 <code>localhost:25000</code> 測試剛剛寫的 <code>/hello</code> 這個 API：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl http:&#x2F;&#x2F;localhost:25000&#x2F;hello</span><br></pre></td></tr></table></figure>
<p>如果剛剛設定了中斷點，應該會發現這個 curl 不會 return。切回 remote VS Code 視窗會發現中斷點被成功觸發了：</p>
<div style="width:100%; text-align:center;">
<img src="/blog/2020/06/21/okteto-vscode-python/python-breakpoint-success.png" width="800px" title="Install flask">
</div>
<p>到這邊就成功設定且測試我們的 Remote Python 開發環境了 👍</p>
<h2 id="Trouble-Shooting-疑難排解"><a class="header-anchor" href="#Trouble-Shooting-疑難排解"></a>Trouble Shooting 疑難排解</h2>
<p>筆者在使用<code>Remote - Kubernetes</code> 遠端開發時經常遇到 <code>Okteto: Up</code> 指令失敗、逾時，或是雖然指令成功，卻沒有連上遠端環境等狀況，這時會需要分段檢查環境問題。</p>
<h3 id="可能性一：遠端環境及-ssh-連線正常，只是-VS-Code-沒有自動連上"><a class="header-anchor" href="#可能性一：遠端環境及-ssh-連線正常，只是-VS-Code-沒有自動連上"></a>可能性一：遠端環境及 ssh 連線正常，只是 VS Code 沒有自動連上</h3>
<p>這時可以先試著使用 Remote-SSH 連回遠端。<code>Cmd + Shift + P</code> 開啟 Command Palette，選擇 <code>Remote-SSH: Connect to Host</code>：</p>
<div style="width:100%; text-align:center;">
<img src="/blog/2020/06/21/okteto-vscode-python/remote-ssh-connect.png" width="400px" title="Install flask">
</div>
<p>再選擇要連線的遠端環境：</p>
<div style="width:100%; text-align:center;">
<img src="/blog/2020/06/21/okteto-vscode-python/remote-ssh-select-host.png" width="400px" title="Install flask">
</div>
<h3 id="可能性二：SSH-連線失效"><a class="header-anchor" href="#可能性二：SSH-連線失效"></a>可能性二：SSH 連線失效</h3>
<p>若直接使用 Remote-SSH 無法連回遠端，則需使用 <code>Okteto: Down</code> Deactivate 目前環境，再用 <code>Okteto: Up</code> 重開。有時候會發生 <code>Okteto: Down</code> 顯示成功，但 <code>Okteto: Up</code> 失敗的狀況，必須多跑幾次後才能再次使用 <code>Okteto: Up</code>。</p>
<h3 id="可能性三：其他-Okteto-Error"><a class="header-anchor" href="#可能性三：其他-Okteto-Error"></a>可能性三：其他 Okteto Error</h3>
<p>Okteto 預設會寫 log 進 <code>~/.okteto/okteto.log</code>，可以看到詳細的錯誤訊息，見招拆招。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail ~&#x2F;.okteto&#x2F;okteto.log</span><br></pre></td></tr></table></figure>
<h2 id="其他設定方式"><a class="header-anchor" href="#其他設定方式"></a>其他設定方式</h2>
<p>我自己測試有一部分的問題是來自於 <code>Remote - Kubernetes</code> 這個插件沒有正確的 launch 遠端環境或設定 port。</p>
<p>另外 <code>Remote - Kubernetes</code> 有另一個很大的限制是一次只能 launch 一個遠端開發環境 (GitHub 上有發相關的 <a href="https://github.com/okteto/remote-kubernetes/issues/101" target="_blank" rel="noopener">issue</a>)。我觀察這是因為 <code>Okteto: Up</code> 這個指令在 command line 寫死了 <code>--remote 22100</code>，即使在 <code>okteto.yml</code> 設定了別的 <code>remote</code>，VS Code 插件這邊也會直接無視，希望之後官方會處理這個 bug。</p>
<p>因為上述的種種不穩問題，我現在都是自己分兩段設定：</p>
<ol>
<li>直接用 <a href="https://okteto.com/docs/reference/cli/index.html" target="_blank" rel="noopener">Okteto CLI</a>，先在 terminal 下  <code>okteto up -f ./okteto.yml</code> 確定環境成功跑起</li>
<li>再用 <code>VS Code Remote SSH</code> 連上遠端環境（也就是 trouble shooting #1 的方式。）</li>
</ol>
<p>兩段式用法有一個比較直接的缺點是，連上遠端後 VS Code 不會自動 cd 進 <code>okteto.yml</code> 裡設定的 <code>workdir</code>，而是會進到 <code>/root/</code>，要自己從 VS Code Side Bar 再切過去。</p>
<p>而前面也有說過其實 <code>Remote - Kubernetes</code> 就是 <code>Okteto</code> + <code>Remote-SSH</code>，所以若採用了這個兩段式用法，基本上可以直接移除 <code>Remote - Kubernetes</code> 了 XDDD<br>
<br/></p>
<h2 id="結語"><a class="header-anchor" href="#結語"></a>結語</h2>
<p>本文簡單介紹了如何使用 Okteto 的 <code>Remote - Kubernetes</code> VS Code extension 來建立 Kubernetes 中的 Python 開發環境。</p>
<p>除了本文介紹的部分以外，Okteto 其實有提供了更多的選項可以設定，包含了設定環境變數、限制 resources、設定多個 port、、設定 secrets 及 PersistentVolume 等等，詳細可以看官方的 <a href="https://okteto.com/docs/reference/manifest/index.html" target="_blank" rel="noopener">Manifest Reference</a></p>
<p>遠端開發對相依於 K8S cluster 的 application 來說相當方便，但因為需要事前設定，我自己開發 API 時還是會先以本機開發 + fake data 為主，直到主要邏輯開發完畢後才放上 development cluster 測試，並搭配中斷點快速修正早期問題。但同事也有人是以 Remote 開發為主（請搭配 <a href="https://okteto.com/docs/reference/manifest/index.html#persistentvolume-object-optional" target="_blank" rel="noopener">persistentVolume</a> 設定服用，否則每次光 Sync files 就要等半天…）。本機與遠端開發的選擇很看個人偏好，用的順手最重要囉。</p>
<h2 id="參考資料"><a class="header-anchor" href="#參考資料"></a>參考資料</h2>
<ul>
<li><a href="https://medium.com/okteto/remote-kubernetes-development-in-visual-studio-code-with-okteto-8b96015b41a6" target="_blank" rel="noopener">Remote Kubernetes Development in Visual Studio Code with Okteto (Golang)</a></li>
<li><a href="https://okteto.com/blog/how-to-develop-python-apps-in-kubernetes/" target="_blank" rel="noopener">How to Develop and Debug Python Applications in Kubernetes (using PyCharm)</a></li>
<li><a href="https://marketplace.visualstudio.com/items?itemName=okteto.remote-kubernetes" target="_blank" rel="noopener">VS Code Remote - Kubernetes</a></li>
<li><a href="https://code.visualstudio.com/docs/remote/ssh" target="_blank" rel="noopener">VS Code Remote - SSH</a></li>
<li><a href="https://okteto.com/docs/reference/manifest/index.html" target="_blank" rel="noopener">Okteto Manifest Reference</a></li>
</ul>
</article><ul class="pager blog-pager"><li class="previous"><a href="/blog/2020/07/26/distributed-tracing-1/" data-toggle="tooltip" data-placement="top" title="Observability 三本柱 - Distributed Tracing 介紹">上一篇</a></li><li class="next"><a href="/blog/2020/06/20/whats-new-in-python-39/" data-toggle="tooltip" data-placement="top" title="Python 3.9 有哪些新玩意？">下一篇</a></li></ul></div></div></div><footer><div class="container beautiful-jekyll-footer"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href="https://github.com/twoyao" target="_blank" rel="noopener" title="GitHub"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-github"></i></span></a></li></ul><p class="copyright text-muted">© Pei-Ya Chiu • 2020 • <a href="mailto:undefined"></a>
</p><p class="theme-by text-muted">Theme by
<a href="https://github.com/twoyao/beautiful-hexo" target="_blank" rel="noopener">beautiful-hexo</a></p></div></div></div></footer><script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script><script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/blog/js/main.js"></script><script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script>(function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
    a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
})(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-169935405-1', 'auto');
ga('send', 'pageview');</script></body></html>